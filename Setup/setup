#!/bin/bash

# Clone this repository or move it to the root directory (/).

# Loads all of the different firewall rules and packages that are required for future operations.

# Run default firewall rules provided to us.
sudo sh firewall_rules.sh
cd /

# Install forever for persistent node (MITM) processes.
sudo npm install -g forever

# Clone and install ACES MITM server.
# git clone https://github.com/fdeegbe/MITM.git
git clone https://github.com/UMD-ACES/MITM
cd ./MITM
sudo ./install.sh

# Ensure execute permissions are added on the recycle script.
chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/recycle

# Execute permissions for data collection script.
chmod +x /1G-Ray-of-Light/DataCollection/collect_data

# Permissions for following
chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogins1
chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogins2
chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogins3
chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogins4
# chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts1
# chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts2
# chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts3
# chmod +x /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts4




# Setup for data collection.
mkdir /Data
touch /Data/cumulative
touch /Data/cumulative_with_attackers
echo "Date Start_Time End_Time Time_In_System Level Sudo_Count Command_Count Downloading_Count Compression_Count RW_Count Usersettings_Count Banner_Count" | sudo tee /Data/cumulative
echo "Date Start_Time End_Time Time_In_System Level Sudo_Count Command_Count Downloading_Count Compression_Count RW_Count Usersettings_Count Banner_Count" | sudo tee /Data/cumulative_with_attackers

# Set up crontab in root crontab.
echo -e "*/10 * * * * /1G-Ray-of-Light/Recycling-LXC-Version/recycle\n*/5 * * * * /1G-Ray-of-Light/DataCollection/collect_data\n@reboot sh /1G-Ray-of-Light/Setup/firewall_rules.sh\n* * * * * ps aux|grep -v grep|grep -q taillogins1 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogins1 &\n* * * * * ps aux|grep -v grep|grep -q taillogouts1 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts1 &\n* * * * * ps aux|grep -v grep|grep -q taillogins2 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogins2 &\n* * * * * ps aux|grep -v grep|grep -q taillogouts2 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts2 &\n* * * * * ps aux|grep -v grep|grep -q taillogins3 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogins3 &\n* * * * * ps aux|grep -v grep|grep -q taillogouts3 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts3 &\n* * * * * ps aux|grep -v grep|grep -q taillogins4 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogins4 &\n* * * * * ps aux|grep -v grep|grep -q taillogouts4 || /1G-Ray-of-Light/Recycling-LXC-Version/taillogouts4 &\n\n" | sudo crontab -



# # Set up crontab in root crontab for the permissions.
# echo -e "*/10 * * * * /1G-Ray-of-Light/Recycling-LXC-Version/recycle\n" | sudo crontab -

# # Set up crontab for data collection.
# echo -e "*/5 * * * * /1G-Ray-of-Light/DataCollection/collect_data\n" >> sudo crontab -

# # Set up firewall rules for reboot
# echo -e "@reboot sh /1G-Ray-of-Light/Setup/firewall_rules.sh\n" >> sudo crontab -